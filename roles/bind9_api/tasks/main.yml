---
# ============================================================================
# BIND9 + REST API Role - Main Tasks
# ============================================================================

- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_distribution }}-{{ ansible_distribution_version }}.yml"
        - "{{ ansible_distribution }}.yml"
        - "{{ ansible_os_family }}.yml"
      skip: true

# ----------------------------------------------------------------------------
# Check for existing API Key on server
# ----------------------------------------------------------------------------
- name: Check if .env file exists on server
  ansible.builtin.stat:
    path: /opt/bind9-api/.env
  register: env_file_stat

- name: Read existing API key from server
  when: env_file_stat.stat.exists
  block:
    - name: Get existing API key from .env
      ansible.builtin.shell: grep '^BIND9_API_AUTH_STATIC_API_KEY=' /opt/bind9-api/.env | cut -d'=' -f2
      register: existing_api_key
      changed_when: false
      failed_when: false

    - name: Use existing API key
      ansible.builtin.set_fact:
        bind9_api_key: "{{ existing_api_key.stdout }}"
      when: existing_api_key.stdout | length > 0

# ----------------------------------------------------------------------------
# Generate API Key if not exists
# ----------------------------------------------------------------------------
- name: Generate API key if not provided and not on server
  when: bind9_api_key is not defined or bind9_api_key == ""
  block:
    - name: Generate secure API key
      ansible.builtin.command: python3 -c "import secrets; print(secrets.token_urlsafe(32))"
      register: generated_api_key
      changed_when: false
      delegate_to: localhost
      become: false

    - name: Set API key fact
      ansible.builtin.set_fact:
        bind9_api_key: "{{ generated_api_key.stdout }}"

# ----------------------------------------------------------------------------
# BIND9 Installation and Configuration
# ----------------------------------------------------------------------------
- name: Install and configure BIND9
  ansible.builtin.include_tasks: bind9.yml
  tags: [bind9]

# ----------------------------------------------------------------------------
# API Installation
# ----------------------------------------------------------------------------
- name: Install and configure BIND9 REST API
  ansible.builtin.include_tasks: api.yml
  tags: [api]

# ----------------------------------------------------------------------------
# Firewall Configuration
# ----------------------------------------------------------------------------
- name: Configure firewall
  ansible.builtin.include_tasks: firewall.yml
  tags: [firewall]
  when: bind9_configure_firewall | default(true)

# ----------------------------------------------------------------------------
# Validation
# ----------------------------------------------------------------------------
- name: Validate deployment
  ansible.builtin.include_tasks: validate.yml
  tags: [validate]
