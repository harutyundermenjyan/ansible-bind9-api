stages:
  - lint
  - syntax
  - deploy

default:
  tags:
    - openbao
  before_script:
    - python3 -m venv .venv
    - . .venv/bin/activate
    - python -m pip install --upgrade pip
    - python -m pip install ansible ansible-lint

variables:
  ANSIBLE_CONFIG: "$CI_PROJECT_DIR/ansible.cfg"

lint:
  stage: lint
  script:
    - ansible-lint site.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

syntax_check:
  stage: syntax
  script:
    - ansible-playbook -i inventories/production/hosts.yml site.yml --syntax-check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

deploy:
  stage: deploy
  before_script:
    - python3 -m venv .venv
    - . .venv/bin/activate
    - python -m pip install --upgrade pip
    - python -m pip install ansible
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - |
      if [ -n "$SSH_PRIVATE_KEY_B64" ]; then
        printf "%s" "$SSH_PRIVATE_KEY_B64" | base64 -d > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
      fi
    - |
      if [ -n "$SSH_KNOWN_HOSTS" ]; then
        printf "%s" "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
      fi
  script:
    - ansible-playbook -i "${ANSIBLE_INVENTORY:-inventories/production/hosts.yml}" site.yml
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: false
